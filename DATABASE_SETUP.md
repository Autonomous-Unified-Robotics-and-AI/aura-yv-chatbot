# Database Setup Guide

This guide walks you through setting up a persistent PostgreSQL database for the Yale Ventures Chatbot using Vercel.

## 1. Set up Vercel PostgreSQL Database

### In Vercel Dashboard:
1. Go to [Vercel Dashboard](https://vercel.com/dashboard)
2. Select your `aura-yv-chatbot` project
3. Go to **Storage** tab
4. Click **Create Database** → **Postgres**
5. Choose:
   - Database name: `yv-chatbot-db`
   - Region: Choose closest to your users
   - Plan: Start with Hobby (free)

### Get Connection Strings:
After creation, Vercel will show you connection strings. Copy these:
- `POSTGRES_PRISMA_URL` (for connection pooling)
- `POSTGRES_URL_NON_POOLING` (for migrations)

## 2. Configure Environment Variables

### For Production (Vercel):
1. In Vercel Dashboard → Project → Settings → Environment Variables
2. Add these variables (Vercel auto-populates database URLs):
   ```
   POSTGRES_PRISMA_URL=<auto-generated>
   POSTGRES_URL_NON_POOLING=<auto-generated>
   OPENAI_API_KEY=<your-key>
   ANTHROPIC_API_KEY=<your-key>
   NOTION_INTEGRATION=<your-token>
   ```

### For Local Development:
1. Copy `.env.local.example` to `.env.local`
2. Fill in the database URLs from Vercel (or use local PostgreSQL)
3. Add your API keys

```bash
cp .env.local.example .env.local
# Edit .env.local with your values
```

## 3. Install Dependencies and Setup Database

```bash
# Install new dependencies
npm install @prisma/client prisma

# Generate Prisma client
npm run db:generate

# Push schema to database (for development)
npm run db:push

# Or run migrations (for production)
npm run db:migrate
```

## 4. Local PostgreSQL Setup (Alternative)

If you want to use local PostgreSQL for development:

### Install PostgreSQL:
```bash
# macOS
brew install postgresql
brew services start postgresql

# Create database
createdb yv_chatbot_db
```

### Update .env.local:
```
POSTGRES_PRISMA_URL="postgresql://username:password@localhost:5432/yv_chatbot_db?connection_limit=20&pool_timeout=20"
POSTGRES_URL_NON_POOLING="postgresql://username:password@localhost:5432/yv_chatbot_db"
```

## 5. Backend Configuration

Update your data extraction scripts to post to the frontend:

### In enhanced_notion_processor.py:
The script now automatically posts extracted data to your frontend API endpoints.

### Environment Variables for Backend:
```bash
# In your aura_rag/.env file
FRONTEND_URL="http://localhost:3000"  # Local development
# FRONTEND_URL="https://your-vercel-app.vercel.app"  # Production
```

## 6. Testing the Setup

### Test Database Connection:
```bash
# Open Prisma Studio to browse data
npm run db:studio
```

### Test Data Extraction:
1. Run your enhanced notion processor
2. Check the admin panel at `/admin` 
3. Verify data appears in the "Extracted Data" tab

### Test API Endpoints:
```bash
# Test data extraction endpoint
curl -X POST http://localhost:3000/api/data-extraction \
  -H "Content-Type: application/json" \
  -d '{
    "dataType": "test",
    "source": "test-source",
    "content": {"test": "data"}
  }'
```

## 7. Production Deployment

1. Deploy to Vercel: `vercel --prod`
2. Vercel automatically sets database environment variables
3. Run migrations: `npx prisma migrate deploy`
4. Update backend FRONTEND_URL to your Vercel domain

## Database Schema

The database includes these main tables:
- `user_sessions` - Chat sessions and user data
- `chat_messages` - Individual messages
- `user_feedback` - User feedback
- `extracted_data` - Data from extraction scripts
- `data_extraction_jobs` - Job tracking

## Monitoring

- Use Vercel Analytics for frontend monitoring
- Use Prisma Studio for database inspection
- Check Vercel Function logs for API errors
- Monitor extraction job status in admin panel

## Troubleshooting

### Common Issues:

1. **Database connection fails**: Check environment variables
2. **Prisma client errors**: Run `npm run db:generate`
3. **Migration errors**: Ensure DATABASE_URL is correct
4. **Local development issues**: Use `npm run db:push` instead of migrations

### Reset Database:
```bash
# Reset local database (caution: deletes all data)
npm run db:push -- --accept-data-loss
```